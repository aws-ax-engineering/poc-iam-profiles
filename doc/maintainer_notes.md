## maintainers notes

### architecture  

_main.tf_  

This configuration is only applied in the `state` account and is related to service accounts (machine users) and service account groups.  

EP infrastructure service account must be placed within the `/POCServiceAccounts/` IAM User path in order for service account credentials to be created and/or rotated.  

_Roles_  

By convention, a unique role is created to match each infrastructure pipeline. A separate terrform file is created for each role, named to match the github repository of the pipeline that uses the role.  

EP infrastructure roles must be placed within the `/POCRoles/` IAM Role path in order for the dependent service account to be able to assume.  

However, for the poc, time does not permit this level of granularity and a sinsgle Terraform Role will be used.  
 
_terraform modules_  

Uses the following AWS official terraform modules: (check for updates)  

terraform-aws-modules/iam/aws//modules/iam-user  
terraform-aws-modules/iam/aws//modules/iam-group-with-assumable-roles-policy  
terraform-aws-modules/iam/aws//modules/iam-assumable-role  

_integration tests_  

The post-run integration tests are limited to testing for the existence of the named role, and that the role has the correct named policy attached. We do not check the details of the individual policy statements. This is because such a test would involve duplicating a long list of permission settings (basically the same as defined within the policy) and then comparing that against the same list in the actual declarative policy file. It is the terraform api that is actually making the configuration change so if is succeeds at all that means it has successfully applied what is defined in the policy file. Therefore checking a list of permissions we write ourselves in one file against another list of the same permission we separately type into another file is actually more likely to result in multiple false-postives then simply using the role in the dependent pipeline and adjusting for failures from there.  

_credential rotation_  

Presently, a scheduled pipeline is configured to run once per week. This pipeline will perform a two-key rotation pattern and then run the integration tests. The effect of which is that POC infrastructure service account credentials are fully rotated every two weeks.  

### local engineering practice additions or notes (See lab-documentation for standard practices and ADRs)  

1. specific .gitignore entries

* Ignore all extensions of .auto.tfvars.json. These are autogenerated during the pipeline run and are ignored so that any local testing doesn't accidently cause problem to the pipeline.  

1. additional pre-commit checks, these checks also done in the pipeline

* [tflint](https://github.com/terraform-linters/tflint)
* [tfsec](https://github.com/aquasecurity/tfsec) _or trivy_
* terraform fmt
* terraform validate
